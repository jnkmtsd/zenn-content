---
title: "Webhook を理解する"
emoji: "⚓"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["webhook"]
published: false
---

## はじめに

Webhook を使ったことがなかったのですが、最近業務で触れる機会があったので色々調べて整理してみました。
概念を知るだけではなく実際に設計する立場になったときに、どのようなことを考える必要があるか、というところまで掘り下げました。

## Webhook とは

**Webhook とは、アプリケーションに対する何らかのイベントをトリガーに、あらかじめ登録しておいた URL へ HTTP POST リクエストを送信する仕組みのことです。**

イベントとは、たとえば GitHub のリポジトリに対する push などのことです。
POST リクエストには、認証のためのヘッダーや、イベントの内容を含むボディが含まれます。

具体例としては以下がわかりやすいです。

https://docs.github.com/ja/webhooks/webhook-events-and-payloads

送信元のサービスは送信先 URL を管理画面などから登録できるようになっているケースが多いです。
自社の Web サーバーを送信先として指定することで、自社サービスと連携することができます。

このように、Webhook の仕組み自体はシンプルです。

## Webhook の設計

送信元を設計する立場になって考えてみましょう。

概ね考えることは以下 3 点です。

- セキュリティ
- UI
- POST するデータ

### セキュリティ

第一に、**送信先に対して正規の送信元だと偽っておかしな POST リクエストを送れないようにする**必要があります。

色々やり方はあると思いますが、GitHub の場合は以下のようなやり方で実現しています。
HMAC 署名を用いたものです。

https://docs.github.com/ja/webhooks/using-webhooks/validating-webhook-deliveries

送信先側の対応にはなりますが、IP 制限を設けてもらうのも有効です。
つまり、送信元の IP のみ通信を受け付けるよう Web サーバーやファイアウォールなどを設定してもらいます。
他社を巻き込んで Webhook を使えるようにする場合、そういった手段があることも覚えておくといいでしょう。

第二に、**色々な送信先 URL を設定されることを考慮する**必要があります。

送信先 URL を送信元が完全にコントロールできる場合はそこまで神経質にならなくてもいいかもしれません。
しかし、GitHub の Webhook のように、送信先を自由に設定できる場合はしっかり考慮する必要があります。

たとえば、`localhost`や送信元ネットワークに属する別サーバーの URL を指定されても問題ない設計になっていますか？
外部からのアクセスは遮断されていても、内部（送信元）からのアクセスはあっさり許可されて不正利用されてしまうかもしれません。

このあたりを考慮して設計、テストしましょう。

他にも、以下のようなことを検討することもいいでしょう。

- 署名した日時を検証する？
- 同一のリクエストを複数回処理しないようにする？

### UI

送信先 URL をユーザーが自由に設定できる場合、送信元はそのインターフェースを用意する必要があります。

このあたり大変な思いをされている様が以下で触れられていました。

https://developers.freee.co.jp/entry/webhook-development-was-hard

### POST するデータ

送信元は、送信先に対して、それぞれのイベントのときどのようなデータを送信するかを考える必要があります。

GitHub のものを参考にするとわかりやすいです。

https://docs.github.com/ja/webhooks/webhook-events-and-payloads

## まとめ

- Webhook とは、アプリケーションに対する何らかのイベントをトリガーに、あらかじめ登録しておいた URL へ HTTP POST リクエストを送信する仕組みのこと
- 設計する際のセキュリティ観点
  - 送信先に対して正規の送信元だと偽っておかしな POST リクエストを送れないようにする
  - 色々な送信先 URL を設定されることを考慮する
- 設計する際は UI を検討する
- 設計する際は POST するデータを検討する

## 参考

- [Webhook のイベントとペイロード - GitHub Docs](https://docs.github.com/ja/webhooks/webhook-events-and-payloads)
- [Webhook 配信を検証する - GitHub Docs](https://docs.github.com/ja/webhooks/using-webhooks/validating-webhook-deliveries)
- [webhook 開発は大変だったので話を聞いて欲しい - freee Developers Hub](https://docs.github.com/ja/webhooks/using-webhooks/validating-webhook-deliveries)
- [Secure な webhook の設計と実装 - Kumanote Tech Blog](https://qiita.com/hirokidaichi/items/1e1b1a5e2e2e2e2e2e2e)
- [Webhook - Wikipedia](https://ja.wikipedia.org/wiki/Webhook)
- [Webhook とは？ - Qiita](https://qiita.com/soarflat/items/ed970f6dc59b2ab76169)
