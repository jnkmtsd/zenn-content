---
title: "バックエンドエンジニアのためのネットワーク基礎【ルーター編】"
emoji: "🌐"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ネットワーク", "ルーター"]
published: true
---

## はじめに

本シリーズの執筆意図などは本シリーズ初回の記事に書いてあります。

- [初回のブラウザ編 > ネットワーク知識の重要性](https://zenn.dev/jnkmtsd/articles/0d129a7aa0947b#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E7%9F%A5%E8%AD%98%E3%81%AE%E9%87%8D%E8%A6%81%E6%80%A7)
- [初回のブラウザ編 > ネットワーク知識を記憶することの困難性](https://zenn.dev/jnkmtsd/articles/0d129a7aa0947b#%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E7%9F%A5%E8%AD%98%E3%82%92%E8%A8%98%E6%86%B6%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AE%E5%9B%B0%E9%9B%A3%E6%80%A7)
- [初回のブラウザ編 > 困難性とどう向き合うか](https://zenn.dev/jnkmtsd/articles/0d129a7aa0947b#%E5%9B%B0%E9%9B%A3%E6%80%A7%E3%81%A8%E3%81%A9%E3%81%86%E5%90%91%E3%81%8D%E5%90%88%E3%81%86%E3%81%8B)

### 本シリーズの記事一覧

- [バックエンドエンジニアのためのネットワーク基礎【ブラウザ編】](https://zenn.dev/jnkmtsd/articles/0d129a7aa0947b)
- [バックエンドエンジニアのためのネットワーク基礎【DNS サーバー編】](https://zenn.dev/jnkmtsd/articles/e59e42beec39e0)
- [バックエンドエンジニアのためのネットワーク基礎【プロトコル・スタック TCP 接続編】](https://zenn.dev/jnkmtsd/articles/e0ecb28f1875f2)
- [バックエンドエンジニアのためのネットワーク基礎【プロトコル・スタック TCP 送受信編】](https://zenn.dev/jnkmtsd/articles/37a25508b30635)
- [バックエンドエンジニアのためのネットワーク基礎【プロトコル・スタック IP 編】](https://zenn.dev/jnkmtsd/articles/61f104becc1750)
- [バックエンドエンジニアのためのネットワーク基礎【イーサネット編】](https://zenn.dev/jnkmtsd/articles/c50f9113995773)
- [バックエンドエンジニアのためのネットワーク基礎【プロトコル・スタック UDP 編】](https://zenn.dev/jnkmtsd/articles/46615811cadd72)
- [バックエンドエンジニアのためのネットワーク基礎【ハブ編】](https://zenn.dev/jnkmtsd/articles/24874950f6e4ea)
- バックエンドエンジニアのためのネットワーク基礎【ルーター編】　 ← 本記事
- [バックエンドエンジニアのためのネットワーク基礎【アクセス回線編】](https://zenn.dev/jnkmtsd/articles/b8588f4326dc73)
- [バックエンドエンジニアのためのネットワーク基礎【プロバイダー編】](https://zenn.dev/jnkmtsd/articles/52b465bc9d8d97)

### 本記事で書かないこと

- ルーター以外の動作
  - 例）LAN アダプタ、ネットワーク・アプリケーション　など
- プロトコルなどの詳しい仕様

## 全体像

[イーサネット編 > 全体像](https://zenn.dev/jnkmtsd/articles/c50f9113995773#%E5%85%A8%E4%BD%93%E5%83%8F)の中の、以下赤枠で示した箇所を細分化していきます。

![](https://storage.googleapis.com/zenn-user-upload/13fd5f1145bd-20231221.png)

それが以下です。

1. ポート部分でパケットを受信
2. 中継部分で中継先を判断
3. 中継先のポート部分でパケットを送信

## Seq.1 ポート部分でパケットを受信

ポート部分の通信技術のルールに従って動きます。
イーサネット、無線 LAN、通信回線など様々な通信技術があります。

:::message
ルーターの各ポートには MAC アドレスと IP アドレスが割り当てられています。
そのため、自分が送信元になったり宛先になったりします。
:::

実際のパケットの受信動作は、イーサネットならパソコンの LAN アダプタと同様です。

受信動作が終わったら、MAC ヘッダーを棄てます。
MAC ヘッダーには、今まさに受信しているルーターの MAC アドレスが書いてあり、役割を終えたからです。

## Seq.2 中継部分で中継先を判断

中継先を判断するために、ルーターは経路表を使います。

表形式で書いて（ヘッダーつき）

| 項目             | 説明                                                                                                                                                                                                                                                                                      |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 宛先             | 基本的にサブネット自体を表す IP アドレス（ホスト番号部分のビット値は全部ゼロ）が入っている。アドレス集約（複数のサブネットをまとめて 1 つのサブネットとみなすこと）がされていることもある。逆もある。ホスト番号部分に値が値が入った個々のコンピュータを表すアドレスを登録することも可能。 |
| ネットマスク     | ネットワーク番号のビット数を判断                                                                                                                                                                                                                                                          |
| ゲートウェイ     | 中継するルーターの IP アドレス                                                                                                                                                                                                                                                            |
| インターフェース | 送信元のポート                                                                                                                                                                                                                                                                            |
| メトリック       | 目的地への距離を示す                                                                                                                                                                                                                                                                      |

経路表は、手動で登録・更新するか、ルーティング・プロトコルを使ってルーター同士経路情報を交換してルーター自身が登録・更新します。

受信したパケットの宛先 IP アドレスと、経路表の宛先欄を比較して中継先を判断します。
ネットワーク番号の部分だけを比較し、かつネットワーク番号のビット数が最も長いものを探します。

:::message
ネットワーク番号の長さが同じものが複数行あったらメトリックの値が小さいものを選ぶ。
:::

該当する行がなかったら、パケットを棄てた上で、送信元に ICMP メッセージを送信します。
しかし、基本的にはそうはなりません。
デフォルト経路（デフォルト・ゲートウェイ）というネットマスク欄を「0.0.0.0」にした行があるからです。
これは、どんなアドレスでも一致して、かつ優先度も最低です。

他にも、TTL を更新したり、フラグメンテーションを行ったりします。

## Seq.3 中継先のポート部分でパケットを送信

実際のパケットの送信動作は、イーサネットならパソコンの LAN アダプタと同様です。

:::message
ルーターは、アドレス変換という仕組みを持っている。
これは、グローバル・アドレスとプライベート・アドレスの変換を行うもの。
アドレスとポートの対応表があり、それを使う。
:::

:::message
ルーターは、パケット・フィルタリングという仕組みを持っている。
これは、ヘッダーを調べて、パケットを棄てるか通すかを決めるもの。
:::

## まとめ

ルーターは以下流れでパケットを中継します。

1. ポート部分でパケットを受信
2. 中継部分で中継先を判断
3. 中継先のポート部分でパケットを送信

## 参考

- [ネットワークはなぜつながるのか　第２版](https://www.amazon.co.jp/dp/B077XSB8BS)
